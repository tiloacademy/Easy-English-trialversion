<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>B√© H·ªçc Ti·∫øng Anh</title>
<style>
/* --- CSS C∆† B·∫¢N --- */
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #87CEEB; margin: 0; padding: 0; height: 100vh; width: 100vw;
overflow: hidden; display: flex; flex-direction: column; user-select: none; }

#menu-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 9999; display: flex; flex-direction: column;
align-items: center; justify-content: center; gap: 15px; }
.menu-title { font-size: 32px; color: #ff6f00; font-weight: bold; margin-bottom: 20px; }
.btn-menu { background: white; border: 3px solid #00A4EF; color: #00A4EF; padding: 15px 40px; border-radius: 50px; font-size: 22px; font-weight: bold;
box-shadow: 0 5px #ccebfd; cursor: pointer; width: 85%; max-width: 350px; transition: transform 0.1s; margin-bottom: 5px; }
.btn-menu:active { transform: scale(0.95); background: #f0f8ff; }

#main-container { width: 100%; height: 100%; position: relative; }
#learning-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column;
padding: 5px 10px 90px 10px; background: #fff; z-index: 10; }

/* UI H·ªçc T·∫≠p */
.top-bar { height: 50px; display: flex; align-items: center; justify-content: space-between; padding: 0 5px; flex-shrink: 0; }
.btn-home { background: #eee; border: none; width: 40px; height: 40px; border-radius: 50%; font-size: 20px; cursor: pointer; }
.header-title { color: #ff6f00; font-size: 20px; font-weight: bold; }
.learn-img-wrapper { flex: 1; width: 100%; min-height: 0; display: flex; align-items: center; justify-content: center; margin: 5px 0; }
#learn-img { max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 15px; }
.info-area { height: 110px; flex-shrink: 0; display: flex; flex-direction: row; align-items: center; justify-content: center; gap: 0px; flex-wrap: wrap; }
.char-block { display: flex; flex-direction: column; align-items: center; justify-content: flex-end; margin: 0; }
.cb-ipa { font-size: 24px; color: red; font-weight: bold; font-family: sans-serif; height: 30px; line-height: 30px; }
.cb-text { font-size: 40px; color: #333; font-weight: bold; height: 50px; line-height: 50px; }
.sent-ipa { font-size: 16px; color: red; font-weight: bold; height: 20px; }
.sent-text { font-size: 24px; color: #333; font-weight: bold; height: 30px; }
.spacer { width: 15px; }
.stars { height: 30px; text-align: center; font-size: 32px; color: #e0e0e0; flex-shrink: 0; }
.stars.active { color: #FFD700; text-shadow: 0 0 5px orange; }
.feedback-text { height: 20px; text-align: center; font-size: 16px; color: #555; font-style: italic; margin-bottom: 5px; }
.action-row { height: 60px; flex-shrink: 0; display: flex; justify-content: center; gap: 15px; align-items: center; margin-bottom: 10px; }
.btn-action { flex: 1; height: 55px; border-radius: 30px; border: none; font-size: 20px; font-weight: bold; cursor: pointer; color: white; display: flex;
align-items: center; justify-content: center; gap: 8px; box-shadow: 0 4px rgba(0,0,0,0.2); max-width: 45%; }
.btn-mic { background: #27ae60; }
.btn-listen { background: #2980b9; }
.btn-game-entry { background: #9b59b6; width: 80%; max-width: none; animation: pulse 1.5s infinite; }
@keyframes pulse { 0% {transform: scale(1);} 50% {transform: scale(1.05);} 100% {transform: scale(1);} }
.nav-row { height: 60px; flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; padding: 0 15px; margin-bottom: 15px; }
.btn-nav { width: 60px; height: 60px; border-radius: 50%; background: #f39c12; color: white; border: none; font-size: 30px; font-weight: bold; cursor: pointer;
box-shadow: 0 4px #d35400; }
.btn-nav:active { transform: translateY(2px); box-shadow: none; }

/* UI Game Chung */
#game-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #fff3e0; z-index: 20; flex-direction: column; }
.game-header { height: 60px; display: flex; justify-content: center; align-items: center; position: relative; background: rgba(255,255,255,0.9); border-bottom: 1px solid #ddd; flex-shrink: 0; }
.timer-badge { background: white; border: 3px solid #d35400; color: #d35400; padding: 5px 25px; border-radius: 25px; font-size: 24px; font-weight: bold; }
.btn-close { position: absolute; right: 10px; background: #c0392b; color: white; width: 45px; height: 45px; border-radius: 50%; border: none; font-weight: bold; font-size: 20px; }
.game-footer { height: 100px; display: flex; justify-content: center; align-items: center; background: white; border-top: 1px solid #ccc; padding-bottom: 30px; flex-shrink: 0;}
#win-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.98); z-index: 100; flex-direction: column; align-items: center; justify-content: center; }

/* CSS Game C≈© (Mole/Flip) */
.tower-container { flex: 1; width: 100%; display: flex; flex-direction: column; justify-content: center; padding: 10px 0; }
.tower-row { flex: 1; width: 100%; display: flex; justify-content: center; align-items: center; gap: 10px; margin-bottom: 5px; }
.card-flip { height: 95%; aspect-ratio: 0.75; position: relative; perspective: 1000px; }
.card-inner { position: relative; width: 100%; height: 100%; transition: transform 0.4s; transform-style: preserve-3d; border-radius: 12px; box-shadow: 0 3px 6px rgba(0,0,0,0.3); }
.card-flip.flipped .card-inner { transform: rotateY(180deg); }
.card-flip.matched .card-inner { opacity: 0; pointer-events: none; }
.face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 12px; display: flex; align-items: center; justify-content: center; border: 2px solid #5d4037; }
.front { background: #8d6e63; color: #3e2723; font-size: 6vh; font-weight: 900; }
.back { background: white; transform: rotateY(180deg); padding: 2px; }
.back img { width: 95%; height: 95%; object-fit: contain; }
.game-card-text { display: flex; flex-direction: row; align-items: center; justify-content: center; height: 100%; width: 100%; flex-wrap: wrap; }
.gc-block { display: flex; flex-direction: column; align-items: center; margin: 0 1px; }
.gc-ipa { color: red; font-weight: bold; font-size: 1.8vh; height: 2vh; }
.gc-word { color: #333; font-weight: bold; font-size: 2.5vh; }
#whack-wrapper { flex: 1; width: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; overflow: hidden; background: linear-gradient(to bottom, #87CEEB 0%, #87CEEB 40%, #8bc34a 40%, #8bc34a 100%); position: relative; padding-bottom: 20px; }
#whack-wrapper::before { content: ' ‚òÅ Ô∏è'; font-size: 60px; position: absolute; top: 30px; left: 20px; opacity: 0.8; }
#whack-wrapper::after { content: ' ‚òÅ Ô∏è'; font-size: 50px; position: absolute; top: 60px; right: 40px; opacity: 0.8; }
.wood-sign { background: #8d6e63; background-image: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(0,0,0,0.05) 10px, rgba(0,0,0,0.05) 20px); border: 4px solid #5d4037; color: white; padding: 5px 15px; border-radius: 10px; font-weight: bold; box-shadow: 0 5px 10px rgba(0,0,0,0.4); text-align: center; min-width: 130px; text-shadow: 1px 1px 0px rgba(0,0,0,0.5); z-index: 10; }
.hud-row { display: flex; gap: 10px; margin-bottom: 10px; margin-top: 5px; z-index: 5; justify-content: center; width: 100%; }
#target-word-container { display: flex; flex-direction: row; justify-content: center; align-items: flex-end; background: white; padding: 5px 15px; border-radius: 8px; border: 2px solid #5d4037; margin-top: 5px; min-height: 45px; }
.target-char { display: flex; flex-direction: column; align-items: center; margin: 0 1px; }
.target-ipa { color: red; font-weight: bold; font-size: 14px; height: 16px; }
.target-txt { color: #333; font-weight: bold; font-size: 24px; }
.score-text { font-size: 24px; color: #fff; font-weight: 900; }
.game-field-3d { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; width: 90%; max-width: 400px; transform: perspective(800px) rotateX(25deg); padding: 20px; background-color: #6d4c41; background-image: radial-gradient(circle, #795548 10%, transparent 10%); background-size: 20px 20px; border-radius: 20px; border: 8px solid #388e3c; box-shadow: 0 20px 0 #2e7d32, 0 25px 25px rgba(0,0,0,0.6); }
.hole { position: relative; aspect-ratio: 1; background: #2b1b13; border-radius: 50%; box-shadow: inset 0 10px 20px black; overflow: hidden; border: 2px solid #5d4037; }
.mole { position: absolute; top: 100%; left: 10%; width: 80%; height: 95%; background: #D2691E; border-radius: 45% 45% 10% 10%; transition: top 0.2s cubic-bezier(0.68, -0.55, 0.265, 1.55); display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding-top: 5px; cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.4); }
.mole::before { content: ' üëÄ '; font-size: 20px; position: absolute; top: 5px; }
.mole::after { content: ' üêΩ '; font-size: 16px; position: absolute; top: 22px; }
.mole.up { top: 0%; }
.mole-card { width: 120%; height: 60%; background: white; border: 3px solid #eee; border-radius: 8px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 8px rgba(0,0,0,0.4); z-index: 2; position: absolute; top: 45%; left: -10%; transform: rotate(-3deg); }
.mole-card img { width: 95%; height: 95%; object-fit: contain; pointer-events: none; }
.hammer { position: fixed; width: 100px; height: 100px; pointer-events: none; z-index: 100000; background-image: url('hammer.png'); background-size: contain; background-repeat: no-repeat; transform-origin: bottom right; display: none; filter: drop-shadow(5px 5px 5px rgba(0,0,0,0.3)); }
.hammer.active { display: block; animation: hammer-hit 0.15s ease-in; }
@keyframes hammer-hit { 0% { transform: rotate(30deg); } 50% { transform: rotate(-45deg) scale(0.9); } 100% { transform: rotate(0deg); } }
.floating-text { position: fixed; font-weight: 900; font-size: 28px; pointer-events: none; z-index: 1000; animation: floatUp 0.8s ease-out forwards; text-shadow: 2px 2px 0px black, -2px -2px 0px white; }
@keyframes floatUp { 0% { opacity: 1; transform: translateY(0) scale(1); } 100% { opacity: 0; transform: translateY(-60px) scale(1.5); } }
.mole.bonked { filter: brightness(1.3) sepia(0.5) hue-rotate(-30deg) saturate(2); transition: none; transform: scale(0.95); }

/* =========================================
   --- CSS ƒê√É C·∫¨P NH·∫¨T THEO Y√äU C·∫¶U M·ªöI (H√åNH TO) ---
========================================= */
#snake-game-container {
    flex: 1; width: 100%; display: none; flex-direction: column; align-items: center; justify-content: flex-start;
    /* N·ªÅn c·ªè xanh nh·∫°t d·ªãu m·∫Øt v·ªõi pattern ch·∫•m c·ªè */
    background-color: #dcedc8;
    background-image: radial-gradient(#8bc34a 2px, transparent 2.5px);
    background-size: 30px 30px; 
    position: relative; overflow: hidden;
}

#snake-target-bar {
    width: 95%; background: rgba(255,255,255,0.95); padding: 5px 15px; border-radius: 12px;
    margin-top: 10px; display: flex; justify-content: space-between; align-items: center;
    box-shadow: 0 4px 6px rgba(0,0,0,0.3); z-index: 20; height: 60px; flex-shrink: 0;
}
.target-label { font-weight: bold; color: #555; font-size: 16px; margin-right: 5px; }
#snake-target-content { display: flex; flex-direction: column; align-items: center; justify-content: center; }
#snake-score { font-size: 22px; font-weight: bold; color: #27ae60; }

.btn-pause { background: #f39c12; color: white; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 20px; font-weight: bold; cursor: pointer; box-shadow: 0 3px #d35400; }
.btn-pause:active { transform: translateY(2px); box-shadow: none; }

#snake-board {
    margin: 5px auto;
    width: 95vw; flex: 1; max-width: 450px;
    background-color: transparent;
    border: none;
    display: grid;
    position: relative;
    z-index: 10;
}

.grid-cell { width: 100%; height: 100%; position: relative; border: none; }

/* R·∫ÆN */
.snake-part {
    width: 100%; height: 100%;
    background-image: url('snake-body.png'); 
    background-size: contain; 
    background-repeat: no-repeat;
    background-position: center;
    z-index: 5;
}
.snake-head {
    background-image: url('snake-head.png');
    z-index: 6; transform-origin: center center; transition: transform 0.1s linear; 
    background-size: contain; 
    background-repeat: no-repeat;
    background-position: center;
}
.head-up { transform: rotate(180deg); }
.head-down { transform: rotate(0deg); }
.head-left { transform: rotate(90deg); }
.head-right { transform: rotate(-90deg); }

/* M·ªíI: ·∫¢nh SI√äU TO KH·ªîNG L·ªí (3.5x) */
.food-item {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    z-index: 2; pointer-events: none;
}
.food-img { 
    width: 350%; height: 350%; /* PH√ìNG ƒê·∫†I T·ªêI ƒêA */
    object-fit: contain; 
    filter: drop-shadow(0 5px 5px rgba(0,0,0,0.5)); 
    z-index: 1; opacity: 1;
}
.food-core { 
    position: absolute; top: 0px; right: 0px; font-size: 10px; 
    background: white; border-radius: 50%; padding: 1px; z-index: 3; opacity: 0.9;
    border: 1px solid #ccc;
}

/* B·ªò ƒêI·ªÄU KHI·ªÇN */
#d-pad {
    position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
    width: 180px; height: 140px;
    display: grid; grid-template-columns: 1fr 1fr 1fr; grid-template-rows: 1fr 1fr;
    gap: 10px; z-index: 50; touch-action: none;
    opacity: 0.6;
}
.d-btn {
    background: rgba(255, 255, 255, 0.4); border: 2px solid white;
    border-radius: 15px; color: #333; font-size: 30px;
    display: flex; align-items: center; justify-content: center; cursor: pointer;
}
.d-btn:active { background: rgba(255, 255, 255, 0.8); transform: scale(0.95); }
.d-up { grid-column: 2; grid-row: 1; }
.d-left { grid-column: 1; grid-row: 2; }
.d-right { grid-column: 3; grid-row: 2; }
.d-down { grid-column: 2; grid-row: 2; }

/* Modal T·∫°m D·ª´ng */
#pause-modal {
    display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.6); z-index: 100;
    flex-direction: column; align-items: center; justify-content: center;
}
.pause-text { color: white; font-size: 40px; font-weight: bold; margin-bottom: 20px; text-shadow: 0 2px 4px black; }
</style>
</head>
<body>
<div id="cursor-hammer" class="hammer"></div>
<div id="menu-screen">
<div class="menu-title">  üìö   CH·ªåN B√ÄI H·ªåC</div>
<button class="btn-menu" onclick="App.startLesson(15)">B√†i 15: /…™r/ & /…õr/</button>
<button class="btn-menu" onclick="App.startLesson(16)">B√†i 16: /a ä/ & /o ä/</button>
<button class="btn-menu" onclick="App.startLesson(17)">B√†i 17: /e…™/ & /a…™/</button>
<button class="btn-menu" onclick="App.startLesson(18)">B√†i 18: /…î…™/ & /tÃ¨/</button>
</div>
<div id="main-container" style="display: none;">
<div id="learning-screen">
<div class="top-bar">
<button class="btn-home" onclick="App.goHome()">  üè†  </button>
<div class="header-title">  üêª   B√© H·ªçc Ti·∫øng Anh   üê∞  </div>
<div style="width: 40px;"></div>
</div>
<div class="learn-img-wrapper"><img id="learn-img" src="" alt="H√¨nh ·∫£nh"></div>
<div class="info-area" id="info-display"></div>
<div class="stars" id="stars">‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ</div>
<div class="feedback-text" id="feedback">...</div>
<div class="action-row" id="action-container">
<button class="btn-action btn-mic" id="mic-btn" onclick="LearningEngine.startListening()">  üé§   ƒê·ªçc Ngay</button>
<button class="btn-action btn-listen" id="btn-replay" onclick="LearningEngine.onUserClickSpeak()">  üîä   Nghe L·∫°i</button>
</div>
<div class="nav-row">
<button class="btn-nav" onclick="LearningEngine.nav(-1)">  ‚óÄ  </button>
<button class="btn-nav" onclick="LearningEngine.nav(1)">  ‚ñ∂  </button>
</div>
</div>
<div id="game-screen" style="display: none;">
<div class="game-header">
    <div style="width:40px;"></div>
    <div class="timer-badge">  ‚è±  Ô∏è <span id="timer">00:00</span></div>
    <button class="btn-close" onclick="App.exitGame()">  ‚úï  </button>
</div>

<div id="tower" class="tower-container" style="display:none;"></div>
<div id="whack-wrapper" style="display:none;">
    <div class="hud-row">
        <div class="wood-sign"><small>M·ª§C TI√äU:</small><br><div id="target-word-container"></div></div>
        <div class="wood-sign"><small>ƒêI·ªÇM S·ªê:</small><br><span id="score-display" class="score-text">0</span></div>
    </div>
    <div class="game-field-3d">
        <div class="hole"><div class="mole" onclick="GameEngine.bonk(this, event)"><div class="mole-card"><img src=""></div></div></div>
        <div class="hole"><div class="mole" onclick="GameEngine.bonk(this, event)"><div class="mole-card"><img src=""></div></div></div>
        <div class="hole"><div class="mole" onclick="GameEngine.bonk(this, event)"><div class="mole-card"><img src=""></div></div></div>
        <div class="hole"><div class="mole" onclick="GameEngine.bonk(this, event)"><div class="mole-card"><img src=""></div></div></div>
        <div class="hole"><div class="mole" onclick="GameEngine.bonk(this, event)"><div class="mole-card"><img src=""></div></div></div>
        <div class="hole"><div class="mole" onclick="GameEngine.bonk(this, event)"><div class="mole-card"><img src=""></div></div></div>
        <div class="hole"><div class="mole" onclick="GameEngine.bonk(this, event)"><div class="mole-card"><img src=""></div></div></div>
        <div class="hole"><div class="mole" onclick="GameEngine.bonk(this, event)"><div class="mole-card"><img src=""></div></div></div>
        <div class="hole"><div class="mole" onclick="GameEngine.bonk(this, event)"><div class="mole-card"><img src=""></div></div></div>
    </div>
</div>

<div id="snake-game-container">
    <div id="snake-target-bar">
        <button class="btn-pause" onclick="SnakeEngine.togglePause()">‚è∏</button>
        <div class="target-label">SƒÉn t·ª´:</div>
        <div id="snake-target-content"></div>
        <div>üèÜ <span id="snake-score">0</span></div>
    </div>
    
    <div id="snake-board"></div>
    
    <div id="d-pad">
        <div></div>
        <div class="d-btn d-up" onclick="SnakeEngine.changeDirection('up')">‚¨ÜÔ∏è</div>
        <div></div>
        
        <div class="d-btn d-left" onclick="SnakeEngine.changeDirection('left')">‚¨ÖÔ∏è</div>
        <div class="d-btn d-down" onclick="SnakeEngine.changeDirection('down')">‚¨áÔ∏è</div>
        <div class="d-btn d-right" onclick="SnakeEngine.changeDirection('right')">‚û°Ô∏è</div>
    </div>

    <div id="pause-modal">
        <div class="pause-text">T·∫†M D·ª™NG</div>
        <button class="btn-menu" style="width:auto;" onclick="SnakeEngine.togglePause()">‚ñ∂ Ti·∫øp t·ª•c ch∆°i</button>
    </div>
</div>

<div class="game-footer">
<button class="btn-action btn-nav" style="width: 60%; border-radius: 30px; font-size: 20px; box-shadow: 0 4px #e67e22; background-color: #e67e22;"
onclick="GameEngine.restart()">  ‚Üª   Ch∆°i l·∫°i</button>
</div>
<div id="win-modal">
<h1 style="color:green; font-size:36px; margin-bottom: 10px;">HO√ÄN TH√ÄNH!   üéâ  </h1>
<h2 style="color:#d35400; font-size:40px; margin: 5px 0;">T·ªïng ƒëi·ªÉm: <span id="final-score">0</span></h2>
<p id="win-msg" style="font-size:20px; color:#555; margin-bottom: 30px;">Th·ªùi gian: 00:00</p>
<button class="btn-action btn-nav" style="width:auto; padding: 0 40px;" onclick="GameEngine.restart()">Ch∆°i l·∫°i</button>
<br><br>
<button class="btn-action btn-listen" style="width:auto; padding: 0 40px;" onclick="LearningEngine.nextItem()">B√†i Ti·∫øp   ‚û°  </button>
</div>
</div>
</div>
<script>
const DataEngine = {
lesson15: [
{ img: "gear.jpg", speak: "gear", pre: "ear", similar: ["near", "year"], parts: [{i:"…™r", t:"gear"}] },
{ img: "deer.jpg", speak: "deer", pre: "ear", similar: ["dear"], parts: [{i:"…™r", t:"deer"}] },
{ img: "cheer.jpg", speak: "cheer", pre: "ear", similar: ["chair"], parts: [{i:"t É", t:"ch"}, {i:"…™r", t:"eer"}] },
{ img: "tear.jpg", speak: "tier", pre: "ear", similar: ["tier", "tea"], parts: [{i:"t", t:"t"}, {i:"…™r", t:"ear"}] },
{ img: "ear.jpg", speak: "ear", pre: "ear", similar: ["year"], parts: [{i:"…™r", t:"ear"}] },
{ img: "bear.jpg", speak: "bear", pre: "air", similar: ["bare"], parts: [{i:"b", t:"b"}, {i:"…õr", t:"ear"}] },
{ img: "pear.jpg", speak: "pear", pre: "air", similar: ["pair"], parts: [{i:"p", t:"p"}, {i:"…õr", t:"ear"}] },
{ img: "share.jpg", speak: "share", pre: "air", similar: ["chair"], parts: [{i:" É", t:"sh"}, {i:"…õr", t:"are"}] },
{ img: "stair.jpg", speak: "stair", pre: "air", similar: ["stare"], parts: [{i:"", t:"st"}, {i:"…õr", t:"air"}] },
{ img: "chair.jpg", speak: "chair", pre: "air", similar: ["cheer"], parts: [{i:"t É", t:"ch"}, {i:"…õr", t:"air"}] },
{ type: "sent", img: "sentence_deer.jpg", speak: "The deer is near the chair", parts: [{i:"√∞…ô", t:"The"}, {t:" "}, {i:"…™r", t:"deer"}, {t:" "}, {i:"…™z", t:"is"}, {t:" "}, {i:"…™r", t:"near"}, {t:" "}, {i:"√∞…ô", t:"the"}, {t:" "}, {i:"t É …õr", t:"chair."}] },
{ type: "sent", img: "sentence_bear.jpg", speak: "The bear shares the pear", parts: [{i:"√∞…ô", t:"The"}, {t:" "}, {i:"…õr", t:"bear"}, {t:" "}, {i:" É …õr z", t:"shares"}, {t:" "}, {i:"√∞…ô", t:"the"}, {t:" "}, {i:"…õr", t:"pear."}] },
{ type: "game", title: "Game /…™r/", pairs: ["gear", "deer", "cheer", "tear", "ear"] },
{ type: "game", title: "Game /…õr/", pairs: ["bear", "pear", "share", "stair", "chair"] }
],
lesson16: [
{ img: "shower.jpg", speak: "shower", pre: "ow", similar: ["show"], parts: [{i:" É", t:"sh"}, {i:"a ä", t:"ow"}, {i:"…ôr", t:"er"}] },
{ img: "shout.jpg", speak: "shout", pre: "ow", similar: ["out"], parts: [{i:" É", t:"sh"}, {i:"a ä", t:"ou"}, {i:"", t:"t"}] },
{ img: "cow.jpg", speak: "cow", pre: "ow", similar: ["how"], parts: [{i:"", t:"c"}, {i:"a ä", t:"ow"}] },
{ img: "brown.jpg", speak: "brown", pre: "ow", similar: ["down"], parts: [{i:"", t:"br"}, {i:"a ä", t:"ow"}, {i:"", t:"n"}] },
{ img: "tower.jpg", speak: "tower", pre: "ow", similar: ["power"], parts: [{i:"", t:"t"}, {i:"a ä", t:"ow"}, {i:"…ôr", t:"er"}] },
{ img: "toe.jpg", speak: "toe", pre: "oh", similar: ["tow"], parts: [{i:"", t:"t"}, {i:"o ä", t:"oe"}] },
{ img: "boat.jpg", speak: "boat", pre: "oh", similar: ["boot"], parts: [{i:"", t:"b"}, {i:"o ä", t:"oa"}, {i:"", t:"t"}] },
{ img: "coat.jpg", speak: "coat", pre: "oh", similar: ["cat"], parts: [{i:"", t:"c"}, {i:"o ä", t:"oa"}, {i:"", t:"t"}] },
{ img: "phone.jpg", speak: "phone", pre: "oh", similar: ["fun"], parts: [{i:"f", t:"ph"}, {i:"o ä", t:"o"}, {i:"", t:"n"}, {i:"_", t:"e"}] },
{ img: "goat.jpg", speak: "goat", pre: "oh", similar: ["got"], parts: [{i:"", t:"g"}, {i:"o ä", t:"oa"}, {i:"", t:"t"}] },
{ type: "sent", img: "sentence_cow.jpg", speak: "The brown cow shouts at the mouse", parts: [{i:"√∞…ô", t:"The"}, {t:" "}, {i:"a ä", t:"brown"}, {t:" "}, {i:"a ä", t:"cow"}, {t:" "}, {i:"a ä", t:"shouts"}, {t:" "}, {i:"√¶", t:"at"}, {t:" "}, {i:"√∞…ô", t:"the"}, {t:" "}, {i:"a ä _", t:"mouse."}] },
{ type: "sent", img: "sentence_joe.jpg", speak: "Joe shows the slow goat the soap", parts: [{i:"d í o ä", t:"Joe"}, {t:" "}, {i:" É o ä z", t:"shows"}, {t:" "}, {i:"√∞…ô", t:"the"}, {t:" "}, {i:"o ä", t:"slow"}, {t:" "}, {i:"o ä", t:"goat"}, {t:" "}, {i:"√∞…ô", t:"the"}, {t:" "}, {i:"o ä", t:"soap."}] },
{ type: "game", title: "Game /a ä/", pairs: ["cow", "brown", "shout", "tower", "shower"] },
{ type: "game", title: "Game /o ä/", pairs: ["toe", "boat", "coat", "phone", "goat"] }
],
lesson17: [
{ img: "face.jpg", speak: "face", pre: "A", similar: [], parts: [{i:"", t:"f"}, {i:"e…™", t:"a"}, {i:"s", t:"c"}, {i:"_", t:"e"}] },
{ img: "cake.jpg", speak: "cake", pre: "A", similar: [], parts: [{i:"", t:"c"}, {i:"e…™", t:"a"}, {i:"", t:"k"}, {i:"_", t:"e"}] },
{ img: "cave.jpg", speak: "cave", pre: "A", similar: [], parts: [{i:"", t:"c"}, {i:"e…™", t:"a"}, {i:"", t:"v"}, {i:"_", t:"e"}] },
{ img: "baby.jpg", speak: "baby", pre: "A", similar: [], parts: [{i:"", t:"b"}, {i:"e…™", t:"a"}, {i:"", t:"b"}, {i:"i:", t:"y"}] },
{ img: "baker.jpg", speak: "baker", pre: "A", similar: [], parts: [{i:"", t:"b"}, {i:"e…™", t:"a"}, {i:"", t:"k"}, {i:"…ôr", t:"er"}] },
{ type: "sent", img: "sentence_vase.jpg", speak: "Kate paints a vase", parts: [{i:"", t:"K"}, {i:"e…™", t:"a"}, {i:"", t:"t"}, {i:"_", t:"e"}, {t:" "}, {i:"", t:"p"}, {i:"e…™", t:"ai"}, {i:"", t:"nts"}, {t:" "}, {i:"…ô", t:"a"}, {t:" "}, {i:"", t:"v"}, {i:"e…™", t:"a"}, {i:"", t:"s"}, {i:"_", t:"e."}] },
{ img: "kite.jpg", speak: "kite", pre: "I", similar: [], parts: [{i:"", t:"k"}, {i:"a…™", t:"i"}, {i:"", t:"t"}, {i:"_", t:"e"}] },
{ img: "bike.jpg", speak: "bike", pre: "I", similar: [], parts: [{i:"", t:"b"}, {i:"a…™", t:"i"}, {i:"", t:"k"}, {i:"_", t:"e"}] },
{ img: "tie.jpg", speak: "tie", pre: "I", similar: [], parts: [{i:"", t:"t"}, {i:"a…™", t:"i"}, {i:"_", t:"e"}] },
{ img: "pine.jpg", speak: "pine", pre: "I", similar: [], parts: [{i:"", t:"p"}, {i:"a…™", t:"i"}, {i:"", t:"n"}, {i:"_", t:"e"}] },
{ img: "cry.jpg", speak: "cry", pre: "I", similar: [], parts: [{i:"", t:"cr"}, {i:"a…™", t:"y"}] },
{ type: "sent", img: "sentence_tiger.jpg", speak: "A tiger bites a kite", parts: [{i:"…ô", t:"A"}, {t:" "}, {i:"", t:"t"}, {i:"a…™", t:"i"}, {i:"", t:"g"}, {i:"…ôr", t:"er"}, {t:" "}, {i:"b", t:"b"}, {i:"a…™", t:"i"}, {i:"", t:"t"}, {i:"_", t:"e"}, {i:"", t:"s"}, {t:" "}, {i:"…ô", t:"a"}, {t:" "}, {i:"", t:"k"}, {i:"a…™", t:"i"}, {i:"", t:"t"}, {i:"_", t:"e."}] },
{ type: "game", title: "SƒÉn Chu·ªôt √¢m /e…™/", gameType: "mole", phoneme: "e…™" },
{ type: "game", title: "SƒÉn Chu·ªôt √¢m /a…™/", gameType: "mole", phoneme: "a…™" }
],
lesson18: [
{ img: "coin.jpg", speak: "coin", pre: "oy", similar: [], parts: [{i:"k", t:"c"}, {i:"…î…™", t:"oin"}] },
{ img: "point.jpg", speak: "point", pre: "oy", similar: [], parts: [{i:"p", t:"p"}, {i:"…î…™", t:"oi"}, {i:"n t", t:"nt"}] },
{ img: "joy.jpg", speak: "joy", pre: "oy", similar: [], parts: [{i:"d í", t:"j"}, {i:"…î…™", t:"oy"}] },
{ img: "boy.jpg", speak: "boy", pre: "oy", similar: [], parts: [{i:"b", t:"b"}, {i:"…î…™", t:"oy"}] },
{ img: "toy.jpg", speak: "toy", pre: "oy", similar: [], parts: [{i:"t", t:"t"}, {i:"…î…™", t:"oy"}] },
{ type: "sent", img: "sentence_boy.jpg", speak: "A boy drops a coin and a toy", parts: [
{i:"…ô", t:"A"}, {t:" "}, {i:"b …î…™", t:"boy"}, {t:" "}, {i:"d r …í p s", t:"drops"}, {t:" "}, {i:"…ô", t:"a"}, {t:" "}, {i:"k …î…™ n", t:"coin"}, {t:" "}, {i:"√¶ n d", t:"and"}, {t:" "}, {i:"…ô", t:"a"}, {t:" "}, {i:"t …î…™", t:"toy."}
]},
{ img: "otter.jpg", speak: "otter", pre: "", similar: [], parts: [{i:"…ë", t:"o"}, {i:"tÃ¨", t:"tt"}, {i:"…ôr", t:"er"}] },
{ img: "butter.jpg", speak: "butter", pre: "", similar: [], parts: [{i:"b", t:"b"}, {i:" å", t:"u"}, {i:"tÃ¨", t:"tt"}, {i:"…ôr", t:"er"}] },
{ img: "kitty.jpg", speak: "kitty", pre: "", similar: [], parts: [{i:"k", t:"k"}, {i:"…™", t:"i"}, {i:"tÃ¨", t:"tt"}, {i:"i:", t:"y"}] },
{ img: "party.jpg", speak: "party", pre: "", similar: [], parts: [{i:"p", t:"p"}, {i:"…ëÀêr", t:"ar"}, {i:"tÃ¨", t:"t"}, {i:"i:", t:"y"}] },
{ img: "city.jpg", speak: "city", pre: "", similar: [], parts: [{i:"s", t:"c"}, {i:"…™", t:"i"}, {i:"tÃ¨", t:"t"}, {i:"i:", t:"y"}] },
{ type: "sent", img: "sentence_peter.jpg", speak: "Peter got butter in the party", parts: [
{i:"P i: tÃ¨ …ôr", t:"Peter"}, {t:" "}, {i:"g …í t", t:"got"}, {t:" "}, {i:"b  å tÃ¨ …ôr", t:"butter"}, {t:" "}, {i:"…™ n", t:"in"}, {t:" "}, {i:"√∞ …ô", t:"the"}, {t:" "}, {i:"p …ëÀêr tÃ¨ i:", t:"party."}
]},
{ type: "game", title: "R·∫Øn SƒÉn Ch·ªØ /…î…™/", gameType: "snake", phoneme: "…î…™" },
{ type: "game", title: "R·∫Øn SƒÉn Ch·ªØ /tÃ¨/", gameType: "snake", phoneme: "tÃ¨" }
],
getLesson: function(num) {
if(num === 15) return this.lesson15;
if(num === 16) return this.lesson16;
if(num === 17) return this.lesson17;
if(num === 18) return this.lesson18;
return [];
}
};

const AudioEngine = {
isAudioAllowed: false, audioWin: new Audio("win.mp3"), audioCorrect: new Audio("correct.mp3"), audioWrong: new Audio("wrong.mp3"), currentUtterance: null,
unlock: function() { this.isAudioAllowed = true; if ('speechSynthesis' in window) { const u = new SpeechSynthesisUtterance(''); window.speechSynthesis.speak(u); window.speechSynthesis.cancel(); } },
stopAllAndBlock: function() { this.isAudioAllowed = false; window.speechSynthesis.cancel(); this.audioWin.pause(); this.audioWin.currentTime = 0; this.audioCorrect.pause(); this.audioCorrect.currentTime = 0; this.audioWrong.pause(); this.audioWrong.currentTime = 0; },
stopCurrentSound: function() { window.speechSynthesis.cancel(); },
playTTS: function(text) { if (!this.isAudioAllowed) return; this.stopCurrentSound(); if ('speechSynthesis' in window) { window.currentUtterance = new SpeechSynthesisUtterance(text); window.currentUtterance.lang = 'en-US'; window.currentUtterance.rate = 0.9; window.speechSynthesis.speak(window.currentUtterance); } },
playEffect: function(type) { if (!this.isAudioAllowed) return; if (type === 'correct') this.audioCorrect.play().catch(e=>{}); if (type === 'wrong') this.audioWrong.play().catch(e=>{}); if (type === 'win') this.audioWin.play().catch(e=>{}); }
};

const GameEngine = {
active: false, moleLoop: null, moleAudioLoop: null, hammerTimeout: null, timerInt: null, score: 0, sec: 0, moles: [], moleRemainingWords: [], moleTarget: null,
currentConfig: null, currentDataPool: [],
start: function(config, dataPool) {
this.currentConfig = config; this.currentDataPool = dataPool;
if (config.gameType === 'snake') { SnakeEngine.start(config, dataPool); return; }
if (config.gameType === 'mole') this.startMoleGame(); else this.startFlipGame();
},
restart: function() { if(this.currentConfig) this.start(this.currentConfig, this.currentDataPool); },
stop: function() {
this.active = false; clearInterval(this.moleAudioLoop); clearTimeout(this.moleLoop); clearInterval(this.timerInt); clearTimeout(this.hammerTimeout);
const allMoles = document.querySelectorAll('.mole'); allMoles.forEach(m => m.classList.remove('up', 'bonked'));
const hammer = document.getElementById('cursor-hammer'); if(hammer) hammer.classList.remove('active');
SnakeEngine.stop();
},
startMoleGame: function() {
this.stop(); this.active = true; this.score = 0; this.sec = 0; this.updateScore(0);
this.moles = document.querySelectorAll('.mole');
document.getElementById('tower').style.display = 'none'; document.getElementById('whack-wrapper').style.display = 'flex'; document.getElementById('win-modal').style.display = 'none'; document.getElementById('snake-game-container').style.display = 'none';
const targetPhoneme = this.currentConfig.phoneme;
this.moleRemainingWords = this.currentDataPool.filter(w => w.parts && w.parts.some(p => p.i.includes(targetPhoneme))).sort(() => 0.5 - Math.random());
if(this.moleRemainingWords.length === 0) return;
this.startTimer(); this.nextMoleRound();
},
nextMoleRound: function() {
if (!this.active) return; if (this.moleRemainingWords.length === 0) { this.win(); return; }
this.moleTarget = this.moleRemainingWords.pop();
let html = ''; this.moleTarget.parts.forEach(p => { const ipaHtml = p.i ? p.i : "&nbsp;"; html += `<div class="target-char"><div class="target-ipa">${ipaHtml}</div><div class="target-txt">${p.t}</div></div>`; });
document.getElementById('target-word-container').innerHTML = html;
AudioEngine.playTTS(this.moleTarget.speak); clearInterval(this.moleAudioLoop);
this.moleAudioLoop = setInterval(() => { if(this.active) AudioEngine.playTTS(this.moleTarget.speak); }, 2500);
this.peep();
},
peep: function() {
if (!this.active) return; const time = Math.round(Math.random() * (1800 - 1000) + 1000); const hole = this.moles[Math.floor(Math.random() * this.moles.length)];
let isTarget = Math.random() < 0.4; let moleImgData = isTarget ? this.moleTarget : this.currentDataPool[Math.floor(Math.random() * this.currentDataPool.length)];
const imgEl = hole.querySelector('img'); imgEl.src = moleImgData.img; hole.dataset.speak = moleImgData.speak; hole.classList.add('up');
this.moleLoop = setTimeout(() => { hole.classList.remove('up'); if (this.active) this.peep(); }, time);
},
bonk: function(moleEl, event) {
if(!moleEl.classList.contains('up') || !this.active) return;
let touchX = event.clientX || event.pageX; let touchY = event.clientY || event.pageY; this.spawnHammer(touchX, touchY);
const clickedWord = moleEl.dataset.speak;
if (clickedWord === this.moleTarget.speak) { AudioEngine.playEffect('correct'); moleEl.classList.add('bonked'); this.updateScore(100); this.showFloatingText(touchX, touchY, "+100", "yellow"); setTimeout(() => { moleEl.classList.remove('up', 'bonked'); clearTimeout(this.moleLoop); this.nextMoleRound(); }, 500); }
else { AudioEngine.playEffect('wrong'); moleEl.classList.remove('up'); this.updateScore(-50); this.showFloatingText(touchX, touchY, "-50", "red"); }
},
spawnHammer: function(x, y) { const hammer = document.getElementById('cursor-hammer'); hammer.style.left = (x - 60) + 'px'; hammer.style.top = (y - 70) + 'px'; hammer.classList.remove('active'); void hammer.offsetWidth; hammer.classList.add('active'); clearTimeout(this.hammerTimeout); this.hammerTimeout = setTimeout(() => { hammer.classList.remove('active'); }, 150); },
startFlipGame: function() {
this.stop(); this.active = true; this.sec = 0; this.matches = 0;
document.getElementById('tower').style.display = 'flex'; document.getElementById('whack-wrapper').style.display = 'none'; document.getElementById('win-modal').style.display = 'none'; document.getElementById('snake-game-container').style.display = 'none';
const tower = document.getElementById('tower'); tower.innerHTML = '';
let cards = [];
this.currentConfig.pairs.forEach(key => {
let original = this.currentDataPool.find(d => { if(d.type === 'game' || d.type === 'sent') return false; let fullWord = d.parts.map(p => p.t).join(""); return fullWord === key; });
if(original) {
cards.push({ id: key, type: 'img', content: `<img src="${original.img}">`, speak: original.speak });
let htmlText = `<div class="game-card-text">`; original.parts.forEach(p => { htmlText += `<div class="gc-block"><div class="gc-ipa">${p.i}</div><div class="gc-word">${p.t}</div></div>`; }); htmlText += `</div>`;
cards.push({ id: key, type: 'text', content: htmlText, speak: original.speak });
}
});
cards.sort(() => 0.5 - Math.random());
let cCount = 0; let num = 1; const rows = [3, 2, 3, 2];
rows.forEach(cnt => {
const rowDiv = document.createElement('div'); rowDiv.className = 'tower-row';
for(let k=0; k<cnt; k++) {
const c = cards[cCount]; const el = document.createElement('div'); el.className = 'card-flip'; el.dataset.speak = c.speak; el.dataset.id = c.id;
el.innerHTML = `<div class="card-inner"><div class="face front">${num}</div><div class="face back">${c.content}</div></div>`;
el.onclick = function() { GameEngine.cardClick(this); }; rowDiv.appendChild(el); cCount++; num++;
}
tower.appendChild(rowDiv);
});
this.startTimer();
},
cardClick: function(el) {
if(el.classList.contains('flipped') || el.classList.contains('matched')) return;
el.classList.add('flipped'); AudioEngine.playTTS(el.dataset.speak);
if(!this.c1) { this.c1 = el; } else { this.c2 = el;
if(this.c1.dataset.id === this.c2.dataset.id) { setTimeout(() => { this.c1.classList.add('matched'); this.c2.classList.add('matched'); this.c1 = null; this.c2 = null; this.matches++; AudioEngine.playEffect('correct'); if(this.matches === 5) this.win(); }, 600); }
else { setTimeout(() => { this.c1.classList.remove('flipped'); this.c2.classList.remove('flipped'); this.c1 = null; this.c2 = null; AudioEngine.playEffect('wrong'); }, 1000); }
}
},
startTimer: function() { clearInterval(this.timerInt); document.getElementById('timer').innerText = "00:00"; this.timerInt = setInterval(() => { this.sec++; let m=Math.floor(this.sec/60).toString().padStart(2,'0'); let s=(this.sec%60).toString().padStart(2,'0'); document.getElementById('timer').innerText = `${m}:${s}`; }, 1000); },
updateScore: function(val) { this.score += val; if(this.score < 0) this.score = 0; document.getElementById('score-display').innerText = this.score; },
showFloatingText: function(x, y, text, color) { const el = document.createElement('div'); el.className = 'floating-text'; el.innerText = text; el.style.left = x + 'px'; el.style.top = y + 'px'; el.style.color = color; document.body.appendChild(el); setTimeout(() => el.remove(), 800); },
win: function() { this.stop(); AudioEngine.playEffect('win'); AudioEngine.playTTS("Excellent job!"); document.getElementById('win-msg').innerText = "Th·ªùi gian: " + document.getElementById('timer').innerText; document.getElementById('final-score').innerText = this.score; document.getElementById('win-modal').style.display = 'flex'; }
};

const SnakeEngine = {
    active: false, paused: false,
    gameLoopId: null, audioLoopId: null,
    boardSize: 15, snake: [], direction: {x: 0, y: 0}, nextDirection: {x: 0, y: 0}, 
    foods: [], score: 0, speed: 300, 
    targetPhoneme: "", currentTargetWord: null,
    poolCorrect: [], poolWrong: [],

    start: function(config, dataPool) {
        this.stop(); 
        this.active = true; 
        this.paused = false;
        this.score = 0; 
        this.speed = 350;
        this.targetPhoneme = config.phoneme;
        
        this.poolCorrect = dataPool.filter(w => w.parts && w.parts.some(p => p.i && p.i.includes(this.targetPhoneme)));
        this.poolWrong = dataPool.filter(w => !w.parts || !w.parts.some(p => p.i && p.i.includes(this.targetPhoneme)));
        
        if (this.poolCorrect.length === 0) return alert("Thi·∫øu d·ªØ li·ªáu √¢m /" + this.targetPhoneme + "/");

        document.getElementById('tower').style.display = 'none';
        document.getElementById('whack-wrapper').style.display = 'none';
        document.getElementById('snake-game-container').style.display = 'flex';
        document.getElementById('win-modal').style.display = 'none';
        document.getElementById('pause-modal').style.display = 'none';
        document.getElementById('snake-score').innerText = this.score;
        
        const center = Math.floor(this.boardSize / 2);
        this.snake = [{x: center, y: center}, {x: center, y: center + 1}, {x: center, y: center + 2}];
        this.direction = {x: 0, y: -1}; this.nextDirection = {x: 0, y: -1};

        this.createBoard();
        this.spawnFoods(); 
        
        this.gameLoop();
        this.startAudioLoop();
    },

    stop: function() { 
        this.active = false; 
        clearTimeout(this.gameLoopId); 
        clearInterval(this.audioLoopId);
    },

    togglePause: function() {
        if (!this.active) return;
        this.paused = !this.paused;
        const modal = document.getElementById('pause-modal');
        if (this.paused) {
            modal.style.display = 'flex';
            clearInterval(this.audioLoopId); 
        } else {
            modal.style.display = 'none';
            this.gameLoop(); 
            this.startAudioLoop();
        }
    },

    startAudioLoop: function() {
        clearInterval(this.audioLoopId);
        if(this.currentTargetWord) AudioEngine.playTTS(this.currentTargetWord.speak);
        this.audioLoopId = setInterval(() => {
            if (this.active && !this.paused && this.currentTargetWord) {
                AudioEngine.playTTS(this.currentTargetWord.speak);
            }
        }, 4000);
    },

    createBoard: function() {
        const board = document.getElementById('snake-board'); board.innerHTML = '';
        board.style.gridTemplateColumns = `repeat(${this.boardSize}, 1fr)`;
        board.style.gridTemplateRows = `repeat(${this.boardSize}, 1fr)`;
        for(let i=0; i < this.boardSize * this.boardSize; i++) {
            const cell = document.createElement('div'); cell.className = 'grid-cell'; board.appendChild(cell);
        }
    },

    gameLoop: function() {
        if (!this.active || this.paused) return;

        this.direction = this.nextDirection;
        const head = { ...this.snake[0] }; head.x += this.direction.x; head.y += this.direction.y;

        if (this.isCollision(head)) { AudioEngine.playEffect('wrong'); this.showGameOver("R·∫Øn ƒë·ª•ng t∆∞·ªùng r·ªìi!"); return; }

        this.snake.unshift(head);
        
        let ate = false;
        const foodIndex = this.foods.findIndex(f => f.x === head.x && f.y === head.y);
        
        if (foodIndex !== -1) {
            const food = this.foods[foodIndex];
            if (food.isCorrect) {
                ate = true; this.score += 10; document.getElementById('snake-score').innerText = this.score;
                AudioEngine.playEffect('correct'); 
                if (this.speed > 150) this.speed -= 10;
                this.foods.splice(foodIndex, 1); this.spawnFoods();
                this.startAudioLoop(); 
                if (this.score >= 100) { this.win(); return; }
            } else {
                AudioEngine.playEffect('wrong'); this.showGameOver(`Sai r·ªìi! "${food.word}" kh√¥ng ph·∫£i t·ª´ c·∫ßn t√¨m!`); return;
            }
        }
        if (!ate) this.snake.pop();
        
        this.draw();
        this.gameLoopId = setTimeout(() => { if(this.active) this.gameLoop(); }, this.speed);
    },

    isCollision: function(pos) {
        if (pos.x < 0 || pos.x >= this.boardSize || pos.y < 0 || pos.y >= this.boardSize) return true;
        for (let i = 1; i < this.snake.length; i++) if (pos.x === this.snake[i].x && pos.y === this.snake[i].y) return true;
        return false;
    },

    spawnFoods: function() {
        this.foods = [];
        const correctWord = this.poolCorrect[Math.floor(Math.random() * this.poolCorrect.length)];
        this.currentTargetWord = correctWord; 

        const wrongWords = this.poolWrong.sort(() => 0.5 - Math.random()).slice(0, 2); 
        
        const itemsToSpawn = [
            { ...correctWord, isCorrect: true, icon: 'üçé' }, 
            { ...wrongWords[0], isCorrect: false, icon: 'üçÑ' }
        ];
        if (wrongWords[1]) itemsToSpawn.push({ ...wrongWords[1], isCorrect: false, icon: 'üí£' });

        itemsToSpawn.forEach(item => {
            let pos;
            do { pos = { x: Math.floor(Math.random() * (this.boardSize - 2)) + 1, y: Math.floor(Math.random() * (this.boardSize - 2)) + 1 }; } while (this.isOccupied(pos));
            
            this.foods.push({ 
                x: pos.x, y: pos.y, 
                img: item.img, 
                word: item.speak, 
                isCorrect: item.isCorrect, 
                icon: item.icon 
            });
        });

        let ipaStr = "";
        if (correctWord.parts) { ipaStr = correctWord.parts.map(p => p.i).join("").replace(/&nbsp;/g, ""); }
        
        document.getElementById('snake-target-content').innerHTML = 
            `<div style="color:red; font-size:14px;">/${ipaStr}/</div>
             <div style="color:#d35400; font-size:24px; font-weight:900;">${correctWord.speak}</div>`;
    },

    isOccupied: function(pos) {
        if (this.snake.some(s => s.x === pos.x && s.y === pos.y)) return true;
        if (this.foods.some(f => f.x === pos.x && f.y === pos.y)) return true;
        const head = this.snake[0]; if (Math.abs(pos.x - head.x) < 3 && Math.abs(pos.y - head.y) < 3) return true;
        return false;
    },

    draw: function() {
        const cells = document.querySelectorAll('.grid-cell');
        cells.forEach(c => { c.className = 'grid-cell'; c.innerHTML = ''; });
        
        this.foods.forEach(f => {
            const idx = f.y * this.boardSize + f.x;
            if (cells[idx]) {
                cells[idx].innerHTML = `
                    <div class="food-item">
                        <img class="food-img" src="${f.img}" onerror="this.style.display='none'">
                        <div class="food-core">${f.icon}</div>
                    </div>
                `;
            }
        });

        this.snake.forEach((part, index) => {
            const idx = part.y * this.boardSize + part.x;
            if (cells[idx]) {
                const div = document.createElement('div'); div.classList.add('snake-part');
                if (index === 0) {
                    div.classList.add('snake-head');
                    if (this.direction.y === -1) div.classList.add('head-down');
                    else if (this.direction.y === 1) div.classList.add('head-up');
                    else if (this.direction.x === -1) div.classList.add('head-left');
                    else if (this.direction.x === 1) div.classList.add('head-right');
                }
                cells[idx].appendChild(div);
            }
        });
    },

    changeDirection: function(newDirName) {
        if (this.paused) return; 
        let newDir = {x:0, y:0};
        if (newDirName === 'up') newDir = {x: 0, y: -1}; if (newDirName === 'down') newDir = {x: 0, y: 1};
        if (newDirName === 'left') newDir = {x: -1, y: 0}; if (newDirName === 'right') newDir = {x: 1, y: 0};
        if (this.direction.x + newDir.x === 0 && this.direction.y + newDir.y === 0) return;
        this.nextDirection = newDir;
    },
    
    showGameOver: function(msg) { this.stop(); AudioEngine.playTTS("Game Over!"); document.getElementById('win-msg').innerText = msg; document.getElementById('final-score').innerText = this.score; document.getElementById('win-modal').style.display = 'flex'; },
    win: function() { this.stop(); AudioEngine.playEffect('win'); AudioEngine.playTTS("You Win!"); document.getElementById('win-msg').innerText = "Tuy·ªát v·ªùi!"; document.getElementById('final-score').innerText = this.score; document.getElementById('win-modal').style.display = 'flex'; }
};

const LearningEngine = {
    currentData: [], idx: 0,
    initLesson: function(lessonNum) { this.currentData = DataEngine.getLesson(lessonNum); this.idx = 0; this.preload(); },
    preload: function() { this.currentData.forEach(item => { if(item.img) new Image().src = item.img; }); },
    render: function() {
        const item = this.currentData[this.idx]; if(!item) return; AudioEngine.stopCurrentSound();
        document.getElementById('game-screen').style.display = 'none'; document.getElementById('learning-screen').style.display = 'flex'; document.getElementById('win-modal').style.display = 'none'; document.getElementById('stars').innerText = "‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ"; document.getElementById('stars').classList.remove('active'); document.getElementById('feedback').innerText = "...";
        const imgEl = document.getElementById('learn-img'); const btnContainer = document.getElementById('action-container'); const infoDisplay = document.getElementById('info-display');
        if(item.type === 'game') {
            imgEl.src = 'https://img.icons8.com/color/500/controller.png'; infoDisplay.innerHTML = `<h2 class="word-display" style="font-size:30px;">${item.title}</h2>`; btnContainer.innerHTML = `<button class="btn-action btn-game-entry" onclick="App.enterGame()">  üöÄ   B·∫Øt ƒê·∫ßu Ch∆°i</button>`;
        } else {
            imgEl.src = item.img; btnContainer.innerHTML = ` <button class="btn-action btn-mic" id="mic-btn" onclick="LearningEngine.startListening()">  üé§   ƒê·ªçc Ngay</button> <button class="btn-action btn-listen" id="btn-replay" onclick="LearningEngine.onUserClickSpeak()">  üîä   Nghe L·∫°i</button> `;
            let html = ''; item.parts.forEach((p) => { if (p.t === " ") html += `<div class="spacer"></div>`; else { const ipaHtml = p.i ? p.i : "&nbsp;"; const textClass = (item.type === 'sent') ? 'sent-text' : 'cb-text'; const ipaClass = (item.type === 'sent') ? 'sent-ipa' : 'cb-ipa'; html += `<div class="char-block"><div class="${ipaClass}">${ipaHtml}</div><div class="${textClass}">${p.t}</div></div>`; } }); infoDisplay.innerHTML = html;
        }
    },
    nav: function(d) { if(this.idx + d >= 0 && this.idx + d < this.currentData.length) { this.idx += d; this.render(); } }, nextItem: function() { this.nav(1); },
    onUserClickSpeak: function() { const item = this.currentData[this.idx]; if(item && item.type !== 'game') { let text = item.speak || item.parts.map(p => p.t).join(""); if(item.pre) text = item.pre + ". " + text; AudioEngine.playTTS(text); } },
    startListening: function() { const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition; if (!SpeechRecognition) return alert("Thi·∫øt b·ªã kh√¥ng h·ªó tr·ª£ thu √¢m"); const btn = document.getElementById('mic-btn'); btn.disabled = true; btn.innerText = "  üëÇ   ƒêang nghe..."; btn.style.backgroundColor = "#e74c3c"; const recognition = new SpeechRecognition(); recognition.lang = 'en-US'; recognition.start(); recognition.onresult = (e) => { let heard = []; for(let i=0; i<e.results[0].length; i++) heard.push(e.results[0][i].transcript.toLowerCase()); this.checkResult(heard); }; recognition.onerror = () => { this.resetMic(); }; recognition.onend = () => { if(btn.disabled) this.resetMic(); }; },
    resetMic: function() { const btn = document.getElementById('mic-btn'); if(btn) { btn.disabled = false; btn.innerText = "  üé§   ƒê·ªçc Ngay"; btn.style.backgroundColor = "#27ae60"; } },
    checkResult: function(heardArray) { const item = this.currentData[this.idx]; const targetRaw = item.speak.toLowerCase().replace(/[.,!?]/g, "").trim(); let validAnswers = [targetRaw]; if (item.pre) validAnswers.push((item.pre + " " + targetRaw).toLowerCase()); let maxScore = 0; for (let text of heardArray) { let userText = text.trim(); for (let target of validAnswers) { if (userText.includes(target) || target.includes(userText)) maxScore = 100; } } let finalStars = 2; let msg = "Try again!"; if (maxScore >= 90) { finalStars = 5; msg = "Excellent!  üéâ "; AudioEngine.playEffect('win'); } else { AudioEngine.playEffect('wrong'); } let s = ""; for(let i=0; i<5; i++) s += (i < finalStars) ? "  ‚≠ê  " : "‚òÜ"; document.getElementById('stars').innerText = s; document.getElementById('stars').className = (finalStars === 5) ? "stars active" : "stars"; document.getElementById('feedback').innerText = msg; this.resetMic(); }
};

const App = {
    startLesson: function(num) { AudioEngine.unlock(); document.getElementById('menu-screen').style.display = 'none'; document.getElementById('main-container').style.display = 'block'; LearningEngine.initLesson(num); LearningEngine.render(); },
    enterGame: function() { document.getElementById('learning-screen').style.display = 'none'; document.getElementById('game-screen').style.display = 'flex'; const item = LearningEngine.currentData[LearningEngine.idx]; const vocabList = LearningEngine.currentData.filter(i => i.img && i.type !== 'sent'); GameEngine.start(item, vocabList); },
    exitGame: function() { GameEngine.stop(); LearningEngine.render(); },
    goHome: function() { AudioEngine.stopAllAndBlock(); GameEngine.stop(); document.getElementById('main-container').style.display = 'none'; document.getElementById('menu-screen').style.display = 'flex'; }
};
window.onload = function() { AudioEngine.stopAllAndBlock(); };
window.addEventListener('keydown', (e) => { if (!SnakeEngine.active) return; if (e.key === 'ArrowUp') SnakeEngine.changeDirection('up'); else if (e.key === 'ArrowDown') SnakeEngine.changeDirection('down'); else if (e.key === 'ArrowLeft') SnakeEngine.changeDirection('left'); else if (e.key === 'ArrowRight') SnakeEngine.changeDirection('right'); });
</script>
</body>
</html>
